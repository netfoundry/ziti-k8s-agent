{{- if and (not .Values.identity.existingSecret.name) (not .Values.identity.json) }}
{{- fail "Either identity.existingSecret.name must be specified (PREFERRED FOR SECURITY) or identity.json must be provided for development/testing" }}
{{- end }}
{{- if and .Values.identity.existingSecret.name .Values.identity.json }}
{{- fail "Cannot specify both identity.existingSecret.name and identity.json - choose one method" }}
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ziti-webhook.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ziti-webhook.labels" . | nindent 4 }}
    app: ziti-admission-webhook
spec:
  replicas: {{ .Values.deployment.replicas }}
  selector:
    matchLabels:
      {{- include "ziti-webhook.selectorLabels" . | nindent 6 }}
      app: ziti-admission-webhook
  template:
    metadata:
      labels:
        {{- include "ziti-webhook.selectorLabels" . | nindent 8 }}
        app: ziti-admission-webhook
    spec:
      containers:
        - name: ziti-admission-webhook
          image: "{{ .Values.deployment.image.repo }}:{{ .Values.deployment.image.tag }}"
          imagePullPolicy: {{ .Values.deployment.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.server.port }}
          args:
            - webhook
            - --v={{ .Values.server.logLevel }}
            - --config=/etc/ziti/webhook/config.yaml
          env:
            - name: TLS_CERT
              valueFrom:
                secretKeyRef:
                  name: {{ include "ziti-webhook.fullname" . }}-tls
                  key: tls.crt
            - name: TLS_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "ziti-webhook.fullname" . }}-tls
                  key: tls.key
            - name: ZITI_IDENTITY_JSON
              valueFrom:
                secretKeyRef:
                  {{- if .Values.identity.existingSecret.name }}
                  name: {{ .Values.identity.existingSecret.name }}
                  key: {{ .Values.identity.existingSecret.key }}
                  {{- else }}
                  name: {{ include "ziti-webhook.fullname" . }}-identity
                  key: {{ include "ziti-webhook.managedSecretKey" . }}
                  {{- end }}
          volumeMounts:
            - name: webhook-config
              mountPath: /etc/ziti/webhook
              readOnly: true
          resources:
            {{- toYaml .Values.deployment.resources | nindent 12 }}
      volumes:
        - name: webhook-config
          configMap:
            name: {{ include "ziti-webhook.fullname" . }}-config
